{% extends "base.html" %}

{% block title %}FanFocusGPT - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h4><i class="fas fa-chart-line"></i> Fan Management Dashboard</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-primary" id="totalFans">0</h5>
                            <small class="text-muted">Total Fans</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-success" id="activeFans">0</h5>
                            <small class="text-muted">Active Today</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-warning" id="kycComplete">0</h5>
                            <small class="text-muted">KYC Complete</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-info" id="bigSpenders">0</h5>
                            <small class="text-muted">Big Spenders</small>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fan ID</th>
                                <th>Type</th>
                                <th>Confidence</th>
                                <th>KYC Progress</th>
                                <th>Last Active</th>
                                <th>Creator</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fansTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading fans...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fan Detail Modal -->
<div class="modal fade" id="fanDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fan Profile Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fanDetailContent">
                <!-- Fan details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class FanDashboard {
    constructor() {
        this.fans = {};
        this.init();
    }

    init() {
        this.loadFans();
        // Refresh every 30 seconds
        setInterval(() => this.loadFans(), 30000);
    }

    async loadFans() {
        try {
            const response = await fetch('/api/all_fans');
            const data = await response.json();

            if (data.success) {
                this.fans = data.fans;
                this.updateStats();
                this.updateTable();
            }
        } catch (error) {
            console.error('Error loading fans:', error);
        }
    }

    updateStats() {
        const totalFans = Object.keys(this.fans).length;
        const activeFans = Object.values(this.fans).filter(fan => {
            const lastActive = new Date(fan.updated_at);
            const now = new Date();
            return (now - lastActive) < 24 * 60 * 60 * 1000; // Last 24 hours
        }).length;

        const kycComplete = Object.values(this.fans).filter(fan => 
            fan.phase0_completion >= 100
        ).length;

        const bigSpenders = Object.values(this.fans).filter(fan => 
            fan.fan_type === 'BS'
        ).length;

        document.getElementById('totalFans').textContent = totalFans;
        document.getElementById('activeFans').textContent = activeFans;
        document.getElementById('kycComplete').textContent = kycComplete;
        document.getElementById('bigSpenders').textContent = bigSpenders;
    }

    updateTable() {
        const tbody = document.getElementById('fansTableBody');

        if (Object.keys(this.fans).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">No fans found</td>
                </tr>
            `;
            return;
        }

        const rows = Object.values(this.fans).map(fan => {
            const fanTypeColor = this.getFanTypeColor(fan.fan_type);
            const confidenceColor = this.getConfidenceColor(fan.confidence);
            const lastActive = new Date(fan.updated_at).toLocaleString();

            return `
                <tr>
                    <td>
                        <code>${fan.fan_id}</code>
                    </td>
                    <td>
                        <span class="badge bg-${fanTypeColor}">
                            ${fan.fan_type || 'Unknown'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${confidenceColor}">
                            ${fan.confidence}
                        </span>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" style="width: ${fan.phase0_completion}%">
                                ${fan.phase0_completion}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <small>${lastActive}</small>
                    </td>
                    <td>
                        <small class="text-muted">Multiple</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="dashboard.showFanDetail('${fan.fan_id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;
    }

    getFanTypeColor(fanType) {
        const colors = {
            'BS': 'success',    // Big Spender
            'BO': 'warning',    // Occasional Buyer
            'FT': 'info',       // Free Trial
            'TW': 'danger',     // Time Waster
            'LK': 'secondary'   // Lurker
        };
        return colors[fanType] || 'secondary';
    }

    getConfidenceColor(confidence) {
        const colors = {
            'LOW': 'danger',
            'MED': 'warning',
            'HIGH': 'success'
        };
        return colors[confidence] || 'secondary';
    }

    showFanDetail(fanId) {
        const fan = this.fans[fanId];
        if (!fan) return;

        const modalContent = document.getElementById('fanDetailContent');
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Fan ID:</strong></td><td><code>${fan.fan_id}</code></td></tr>
                        <tr><td><strong>Status:</strong></td><td>${fan.status}</td></tr>
                        <tr><td><strong>Fan Type:</strong></td><td>
                            <span class="badge bg-${this.getFanTypeColor(fan.fan_type)}">
                                ${fan.fan_type || 'Unknown'}
                            </span>
                        </td></tr>
                        <tr><td><strong>Confidence:</strong></td><td>
                            <span class="badge bg-${this.getConfidenceColor(fan.confidence)}">
                                ${fan.confidence}
                            </span>
                        </td></tr>
                        <tr><td><strong>Personality:</strong></td><td>${fan.personality || 'Not determined'}</td></tr>
                        <tr><td><strong>Purchase Interest:</strong></td><td>${fan.purchase_interest}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>KYC Progress</h6>
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar" style="width: ${fan.phase0_completion}%">
                            Phase 0: ${fan.phase0_completion}%
                        </div>
                    </div>

                    <h6>Preferences & Notes</h6>
                    <div class="small">
                        <strong>Key Preferences:</strong><br>
                        ${fan.key_preferences.length ? fan.key_preferences.join(', ') : 'None yet'}
                        <br><br>
                        <strong>Notes:</strong><br>
                        ${fan.notes || 'No notes yet'}
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <h6>Activity Timeline</h6>
                <div class="small text-muted">
                    <strong>Created:</strong> ${new Date(fan.created_at).toLocaleString()}<br>
                    <strong>Last Updated:</strong> ${new Date(fan.updated_at).toLocaleString()}
                </div>
            </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('fanDetailModal'));
        modal.show();
    }
}

// Initialize dashboard
let dashboard;
document.addEventListener('DOMContentLoaded', function() {
    dashboard = new FanDashboard();
});
</script>
{% endblock %}